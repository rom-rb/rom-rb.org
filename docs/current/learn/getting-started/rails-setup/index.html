<!DOCTYPE html><html><head><meta charset="utf-8" /><meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible" /><meta content="initial-scale=1" name="viewport" /><title>ROM - Rails Setup</title><link href="/assets/stylesheets/all.css" rel="stylesheet" /><script src="/assets/javascripts/all.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-2573270-5', 'auto');
ga('send', 'pageview');</script></head><body class="current current_learn current_learn_getting-started current_learn_getting-started_rails-setup current_learn_getting-started_rails-setup_index"><div class="page"><div class="grid"><header class="header"><div class="header__logo"><a href="/" class="header__logo__link">Ruby Object Mapper</a></div><div class="header__menu-toggler" id="navigation__toggler"><span class="fa fa-navicon"></span></div><div class="header__menu" id="navigation__items"><nav class="menu"><ul class="menu__items"><li class="menu__item"><a href="/current/learn" class="menu__item__link--is-active">Learn</a></li><li class="menu__item"><a href="/current/guides" class="menu__item__link">Guides</a></li><li class="menu__item"><a href="/api" class="menu__item__link">API</a></li><li class="menu__item"><a href="/blog" class="menu__item__link">Blog</a></li><li class="menu__item"><a href="/contribute" class="menu__item__link">Contribute</a></li><li class="menu__item"><a href="https://discourse.rom-rb.org" class="menu__item__link">Discuss</a></li><li class="menu__item"><a href="/status" class="menu__item__link">Status</a></li><li class="menu__item--last"><a href="https://opencollective.com/rom" class="menu__item__link">Donate</a></li></ul></nav></div></header><div class="page__sidebar"><div class="sidebar"><h3 class="sidebar__version">Version: <select id="sidebar__version-switcher"><option value="/3.0/learn/getting-started/rails-setup/index.html">3.0</option><option selected="selected" value="/current/learn/getting-started/rails-setup/index.html">current (3.0)</option><option value="/next/learn/getting-started/rails-setup/index.html">next (4.0)</option></select></h3><h2 class="sidebar__header--first">Learn</h2><ul class="sidebar__items"><li class="sidebar__item"><a href="/current/learn/introduction/" class="sidebar__link">Introduction</a><ul class="sidebar__sub-items"><li class="sidebar__sub-item"><a href="/current/learn/introduction/philosophy/" class="sidebar__sub-link">Philosophy</a></li><li class="sidebar__sub-item"><a href="/current/learn/introduction/why/" class="sidebar__sub-link">Why ROM?</a></li><li class="sidebar__sub-item"><a href="/current/learn/introduction/overview/" class="sidebar__sub-link">Overview</a></li><li class="sidebar__sub-item"><a href="/current/learn/introduction/active-record/" class="sidebar__sub-link">Active Record and ROM</a></li></ul></li><li class="sidebar__item"><a href="/current/learn/getting-started/" class="sidebar__link--is-active">Getting Started</a><ul class="sidebar__sub-items"><li class="sidebar__sub-item"><a href="/current/learn/getting-started/setup-dsl/" class="sidebar__sub-link">Setup DSL</a></li><li class="sidebar__sub-item"><a href="/current/learn/getting-started/rails-setup/" class="sidebar__sub-link--is-active">Rails Setup</a></li></ul></li><li class="sidebar__item"><a href="/current/learn/core/" class="sidebar__link">Core</a><ul class="sidebar__sub-items"><li class="sidebar__sub-item"><a href="/current/learn/core/relations/" class="sidebar__sub-link">Relations</a></li><li class="sidebar__sub-item"><a href="/current/learn/core/schemas/" class="sidebar__sub-link">Schemas</a></li></ul></li><li class="sidebar__item"><a href="/current/learn/repositories/" class="sidebar__link">Repositories</a><ul class="sidebar__sub-items"><li class="sidebar__sub-item"><a href="/current/learn/repositories/quick-start/" class="sidebar__sub-link">Quick Start</a></li><li class="sidebar__sub-item"><a href="/current/learn/repositories/reading-simple-objects/" class="sidebar__sub-link">Reading Simple Objects</a></li><li class="sidebar__sub-item"><a href="/current/learn/repositories/reading-aggregates/" class="sidebar__sub-link">Reading Aggregates</a></li><li class="sidebar__sub-item"><a href="/current/learn/repositories/changesets/" class="sidebar__sub-link">Changesets</a></li><li class="sidebar__sub-item"><a href="/current/learn/repositories/composing-relations/" class="sidebar__sub-link">Composing Relations</a></li><li class="sidebar__sub-item"><a href="/current/learn/repositories/custom-changesets/" class="sidebar__sub-link">Custom Changesets</a></li><li class="sidebar__sub-item"><a href="/current/learn/repositories/changeset-transactions/" class="sidebar__sub-link">Changeset Transactions & Associations</a></li><li class="sidebar__sub-item"><a href="/current/learn/repositories/writing-aggregates/" class="sidebar__sub-link">Writing Aggregates</a></li></ul></li><li class="sidebar__item"><a href="/current/learn/sql/" class="sidebar__link">SQL</a><ul class="sidebar__sub-items"><li class="sidebar__sub-item"><a href="/current/learn/sql/relations/" class="sidebar__sub-link">Relations</a></li><li class="sidebar__sub-item"><a href="/current/learn/sql/schemas/" class="sidebar__sub-link">Schemas</a></li><li class="sidebar__sub-item"><a href="/current/learn/sql/queries/" class="sidebar__sub-link">Queries</a></li><li class="sidebar__sub-item"><a href="/current/learn/sql/attributes/" class="sidebar__sub-link">Attributes</a></li><li class="sidebar__sub-item"><a href="/current/learn/sql/associations/" class="sidebar__sub-link">Associations</a></li><li class="sidebar__sub-item"><a href="/current/learn/sql/joins/" class="sidebar__sub-link">Joins</a></li><li class="sidebar__sub-item"><a href="/current/learn/sql/transactions/" class="sidebar__sub-link">Transactions</a></li><li class="sidebar__sub-item"><a href="/current/learn/sql/migrations/" class="sidebar__sub-link">Migrations</a></li><li class="sidebar__sub-item"><a href="/current/learn/sql/commands/" class="sidebar__sub-link">Commands</a></li></ul></li><li class="sidebar__item"><a href="/current/learn/kafka/" class="sidebar__link">Kafka</a></li><li class="sidebar__item"><a href="/current/learn/advanced/" class="sidebar__link">Advanced</a><ul class="sidebar__sub-items"><li class="sidebar__sub-item"><a href="/current/learn/advanced/explicit-setup/" class="sidebar__sub-link">Explicit Setup</a></li><li class="sidebar__sub-item"><a href="/current/learn/advanced/combine/" class="sidebar__sub-link">Combining Relation Results</a></li><li class="sidebar__sub-item"><a href="/current/learn/advanced/commands/" class="sidebar__sub-link">Standalone Commands</a></li><li class="sidebar__sub-item"><a href="/current/learn/advanced/custom-commands/" class="sidebar__sub-link">Custom Commands</a></li><li class="sidebar__sub-item"><a href="/current/learn/advanced/mappers/" class="sidebar__sub-link">Mappers</a></li><li class="sidebar__sub-item"><a href="/current/learn/advanced/how-to-build-an-adapter/" class="sidebar__sub-link">Adapters</a></li></ul></li><li class="sidebar__item"><a href="/current/learn/glossary/" class="sidebar__link">Glossary</a></li></ul></div></div><div class="page__content"><div class="content"><h1>Getting Started &raquo; Rails Setup</h1><p>Rails integration is provided by
<a href="https://github.com/rom-rb/rom-rails">rom-rails</a> project. Simply add it to your
Gemfile:</p>
<pre class="syntax ruby"><code><span class="n">gem</span> <span class="s1">'rom-rails'</span>
</code></pre>
<h2>Configuring Railtie</h2>

<p>Create a rom initializer:</p>
<pre class="syntax ruby"><code><span class="c1"># config/initializers/rom.rb</span>
<span class="no">ROM</span><span class="o">::</span><span class="no">Rails</span><span class="o">::</span><span class="no">Railtie</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">gateways</span><span class="p">[</span><span class="ss">:default</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="ss">:sql</span><span class="p">,</span> <span class="no">ENV</span><span class="p">.</span><span class="nf">fetch</span><span class="p">(</span><span class="s1">'DATABASE_URL'</span><span class="p">)]</span>
<span class="k">end</span>
</code></pre>
<p>You can provide additional adapter-specific options, for example you can enable
specific sql plugins for postgres:</p>
<pre class="syntax ruby"><code><span class="c1"># config/initializers/rom.rb</span>
<span class="no">ROM</span><span class="o">::</span><span class="no">Rails</span><span class="o">::</span><span class="no">Railtie</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">gateways</span><span class="p">[</span><span class="ss">:default</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="ss">:sql</span><span class="p">,</span>
    <span class="no">ENV</span><span class="p">.</span><span class="nf">fetch</span><span class="p">(</span><span class="s1">'DATABASE_URL'</span><span class="p">),</span> <span class="ss">extensions: </span><span class="p">[</span><span class="ss">:pg_hstore</span><span class="p">]</span>
  <span class="p">]</span>
<span class="k">end</span>
</code></pre>
<p>You can also provide a list of relations that should not be inferred from your
schema automatically:</p>
<pre class="syntax ruby"><code><span class="c1"># config/initializers/rom.rb</span>
<span class="no">ROM</span><span class="o">::</span><span class="no">Rails</span><span class="o">::</span><span class="no">Railtie</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">gateways</span><span class="p">[</span><span class="ss">:default</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="ss">:sql</span><span class="p">,</span>
    <span class="no">ENV</span><span class="p">.</span><span class="nf">fetch</span><span class="p">(</span><span class="s1">'DATABASE_URL'</span><span class="p">),</span> <span class="ss">not_inferrable_relations: </span><span class="p">[</span><span class="ss">:schema_migrations</span><span class="p">]</span>
  <span class="p">]</span>
<span class="k">end</span>
</code></pre>
<h2>Migration Tasks</h2>

<p>The railtie provides rake tasks for managing your database schema. You need to
enable them in your <code>Rakefile</code>:</p>
<pre class="syntax ruby"><code><span class="nb">require</span> <span class="s1">'rom/sql/rake_task'</span>
</code></pre>
<p>After that, you have access to following tasks:</p>

<ul>
<li><code>rake db:create_migration[migration_name]</code> - creates a new migration file</li>
<li><code>rake db:migrate</code> - runs pending migrations</li>
<li><code>rake db:clean</code> - cleans the database</li>
<li><code>rake db:reset</code> - drops tables and re-runs migrations</li>
</ul>

<h2>Accessing Container</h2>

<p>In Rails environment ROM container is accessible via <code>ROM.env</code>:</p>
<pre class="syntax ruby"><code><span class="no">ROM</span><span class="p">.</span><span class="nf">env</span> <span class="c1"># returns the container</span>
</code></pre>
<p>In your controllers you can access ROM container by <code>rom</code> variable:</p>
<pre class="syntax ruby"><code><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">show</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">rom</span><span class="p">.</span><span class="nf">relation</span><span class="p">(</span><span class="ss">:users</span><span class="p">).</span><span class="nf">by_id</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">]).</span><span class="nf">one</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<blockquote>
<p>Accessing the global container directly is considered as a bad practice. The
recommended way is to use a DI mechanism to inject specific ROM components as
dependencies into your objects.</p>

<p>For example you can use <a href="https://github.com/dryrb/dry-container">dry-container</a>
and <a href="https://github.com/dryrb/dry-auto_inject">dry-auto_inject</a> to define
your own application container and specify dependencies there to have them
automatically injected.</p>

<p>See <a href="https://github.com/solnic/rom-rails-skeleton">rom-rails-skeleton</a> for an
example of such setup.</p>
</blockquote>

<h2>Defining Relations</h2>

<p>Relation class definitions are automatically loaded from <code>app/relations</code>.
The following code defines a <code>users</code> relation for the <code>:sql</code> adapter:</p>
<pre class="syntax ruby"><code><span class="k">class</span> <span class="nc">Users</span> <span class="o">&lt;</span> <span class="no">ROM</span><span class="o">::</span><span class="no">Relation</span><span class="p">[</span><span class="ss">:sql</span><span class="p">]</span>
  <span class="c1"># some methods</span>
<span class="k">end</span>

<span class="c1"># access registered relation via container</span>
<span class="no">ROM</span><span class="p">.</span><span class="nf">env</span><span class="p">.</span><span class="nf">relations</span><span class="p">[</span><span class="ss">:users</span><span class="p">]</span>
</code></pre>
<h2>Defining Commands</h2>

<p>Command class definitions are automatically loaded from <code>app/commands</code>.
The following code defines a command which inserts data into <code>users</code> relation:</p>
<pre class="syntax ruby"><code><span class="c1"># app/commands/create_user.rb</span>
<span class="k">class</span> <span class="nc">CreateUser</span> <span class="o">&lt;</span> <span class="no">ROM</span><span class="o">::</span><span class="no">Commands</span><span class="o">::</span><span class="no">Create</span><span class="p">[</span><span class="ss">:sql</span><span class="p">]</span>
  <span class="n">relation</span> <span class="ss">:users</span>
  <span class="n">register_as</span> <span class="ss">:create</span>
  <span class="n">result</span> <span class="ss">:one</span>
<span class="k">end</span>

<span class="c1"># access registered relation via container</span>
<span class="no">ROM</span><span class="p">.</span><span class="nf">env</span><span class="p">.</span><span class="nf">commands</span><span class="p">[</span><span class="ss">:users</span><span class="p">][</span><span class="ss">:create</span><span class="p">]</span>
</code></pre>
<h2>Defining Custom Mappers</h2>

<p>If you want to use custom mappers you can place them under <code>app/mappers</code>:</p>
<pre class="syntax ruby"><code><span class="c1"># app/mappers/user_mapper.rb</span>
<span class="k">class</span> <span class="nc">UserMapper</span> <span class="o">&lt;</span> <span class="no">ROM</span><span class="o">::</span><span class="no">Mapper</span>
  <span class="n">relation</span> <span class="ss">:users</span>

  <span class="c1"># some mapping logic</span>
<span class="k">end</span>
</code></pre>
<h2>Running alongside ActiveRecord</h2>

<p>There might be some cases where you will want to run ROM alongside ActiveRecord.
Since ROM is designed to work independently, you will need to take few additional steps.</p>

<p>ROM creates its own connections and Rails above version 5 won&#39;t allow you to drop the 
database since there are active connections on it.</p>
<pre class="syntax ruby"><code><span class="c1"># lib/tasks/db.rake</span>
<span class="n">task</span> <span class="ss">:remove_rom_connection</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="ss">:environment</span><span class="p">]</span> <span class="k">do</span>
  <span class="no">ROM</span><span class="p">.</span><span class="nf">env</span> <span class="o">&amp;&amp;</span> <span class="no">ROM</span><span class="p">.</span><span class="nf">env</span><span class="p">.</span><span class="nf">disconnect</span>
<span class="k">end</span>

<span class="no">Rake</span><span class="o">::</span><span class="no">Task</span><span class="p">[</span><span class="s2">"db:drop"</span><span class="p">].</span><span class="nf">clear_prerequisites</span><span class="p">()</span>
<span class="no">Rake</span><span class="o">::</span><span class="no">Task</span><span class="p">[</span><span class="s2">"db:drop"</span><span class="p">].</span><span class="nf">enhance</span> <span class="p">[</span><span class="ss">:remove_rom_connection</span><span class="p">,</span> <span class="ss">:load_config</span><span class="p">,</span> <span class="ss">:check_protected_environments</span><span class="p">]</span>

<span class="no">Rake</span><span class="o">::</span><span class="no">Task</span><span class="p">[</span><span class="s2">"db:reset"</span><span class="p">].</span><span class="nf">clear_prerequisites</span><span class="p">()</span>
<span class="no">Rake</span><span class="o">::</span><span class="no">Task</span><span class="p">[</span><span class="s2">"db:reset"</span><span class="p">].</span><span class="nf">enhance</span> <span class="p">[</span><span class="ss">:remove_rom_connection</span><span class="p">,</span> <span class="s2">"db:drop"</span><span class="p">,</span> <span class="s2">"db:setup"</span><span class="p">]</span>
</code></pre>
<p>Since migrations (and other) tasks require environment, ROM will be loaded and
will throw an exception, because relations will try to load tables before
migrations have actually run. We know this is an ugly solution, but we are working hard
to solve this case. This monkey patch will give you reasonable information to
act upon if the necessity arises.</p>
<pre class="syntax ruby"><code><span class="c1"># config/initializers/rom_monkey.rb</span>
<span class="k">module</span> <span class="nn">ROM</span>
  <span class="k">module</span> <span class="nn">Rails</span>
    <span class="k">class</span> <span class="nc">Railtie</span> <span class="o">&lt;</span> <span class="o">::</span><span class="no">Rails</span><span class="o">::</span><span class="no">Railtie</span>
      <span class="kp">alias_method</span> <span class="ss">:create_container!</span><span class="p">,</span> <span class="ss">:create_container</span>
      <span class="k">def</span> <span class="nf">create_container</span>
        <span class="k">begin</span>
          <span class="n">create_container!</span>
        <span class="k">rescue</span> <span class="o">=&gt;</span> <span class="n">e</span>
          <span class="nb">puts</span> <span class="s2">"Container failed to initialize because of </span><span class="si">#{</span><span class="n">e</span><span class="p">.</span><span class="nf">inspect</span><span class="si">}</span><span class="s2">"</span>
          <span class="nb">puts</span> <span class="s2">"This message comes from the monkey patch in </span><span class="si">#{</span><span class="kp">__FILE__</span><span class="si">}</span><span class="s2">, if you are using rake, then this is fine"</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div></div></div><div class="footer"><div class="grid"><div class="footer__content"><h3 class="footer__header">Sponsors</h3><p>We are looking for sustainable sponsorship. If your company is relying
on rom-rb or simply want to see rom-rb evolve faster to meet your requirements,
please consider backing the project through <a href="https://opencollective.com/rom">our campaign on
opencollective.com/rom</a>.</p>
</div><div class="footer__fine-print"><div class="footer__fine-print__copyright"><small>&copy; 2014-2017 Ruby Object Mapper. Design by <a href="https://github.com/angeloashmore">@angeloashmore</a>. Logo by <a href="https://github.com/kapowaz">@kapowaz</a>.</small></div><div class="footer__fine-print__social"><a href="https://github.com/rom-rb/rom" class="footer__fine-print__social__icon"><span class="fa fa-github-alt"></span></a><a href="https://twitter.com/rom_rb" class="footer__fine-print__social__icon--last"><span class="fa fa-twitter"></span></a></div></div></div></div></body></html>