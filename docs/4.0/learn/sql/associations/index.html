<!DOCTYPE html><html><head><meta charset="utf-8" /><meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible" /><meta content="initial-scale=1" name="viewport" /><title>ROM - Associations</title><link href="/assets/stylesheets/all.css" rel="stylesheet" /><script src="/assets/javascripts/all.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-2573270-5', 'auto');
ga('send', 'pageview');</script></head><body class="x4"><div class="page"><div class="grid"><header class="header"><div class="header__logo"><a href="/" class="header__logo__link">Ruby Object Mapper</a></div><div class="header__menu-toggler" id="navigation__toggler"><span class="fa fa-navicon"></span></div><div class="header__menu" id="navigation__items"><nav class="menu"><ul class="menu__items"><li class="menu__item"><a href="/4.0/learn" class="menu__item__link--is-active">Learn</a></li><li class="menu__item"><a href="/4.0/guides" class="menu__item__link">Guides</a></li><li class="menu__item"><a href="/api" class="menu__item__link">API</a></li><li class="menu__item"><a href="/blog" class="menu__item__link">Blog</a></li><li class="menu__item"><a href="/contribute" class="menu__item__link">Contribute</a></li><li class="menu__item"><a href="https://discourse.rom-rb.org" class="menu__item__link">Discuss</a></li><li class="menu__item"><a href="/status" class="menu__item__link">Status</a></li><li class="menu__item--last"><a href="https://opencollective.com/rom" class="menu__item__link">Donate</a></li></ul></nav></div></header><div class="page__sidebar"><div class="sidebar"><h3 class="sidebar__version">Version: <select id="sidebar__version-switcher"><option value="/3.0/learn/sql/associations/index.html">3.0</option><option value="/current/learn/sql/associations/index.html">current (3.0)</option><option value="/next/learn/sql/associations/index.html">next (4.0)</option></select></h3><h2 class="sidebar__header--first">Learn</h2><ul class="sidebar__items"><li class="sidebar__item"><a href="/4.0/learn/introduction/" class="sidebar__link">Introduction</a><ul class="sidebar__sub-items"><li class="sidebar__sub-item"><a href="/4.0/learn/introduction/philosophy/" class="sidebar__sub-link">Philosophy</a></li><li class="sidebar__sub-item"><a href="/4.0/learn/introduction/why/" class="sidebar__sub-link">Why ROM?</a></li><li class="sidebar__sub-item"><a href="/4.0/learn/introduction/overview/" class="sidebar__sub-link">Overview</a></li><li class="sidebar__sub-item"><a href="/4.0/learn/introduction/active-record/" class="sidebar__sub-link">Active Record and ROM</a></li></ul></li><li class="sidebar__item"><a href="/4.0/learn/getting-started/" class="sidebar__link">Getting Started</a><ul class="sidebar__sub-items"><li class="sidebar__sub-item"><a href="/4.0/learn/getting-started/setup-dsl/" class="sidebar__sub-link">Setup DSL</a></li><li class="sidebar__sub-item"><a href="/4.0/learn/getting-started/rails-setup/" class="sidebar__sub-link">Rails Setup</a></li></ul></li><li class="sidebar__item"><a href="/4.0/learn/core/" class="sidebar__link">Core</a><ul class="sidebar__sub-items"><li class="sidebar__sub-item"><a href="/4.0/learn/core/relations/" class="sidebar__sub-link">Relations</a></li><li class="sidebar__sub-item"><a href="/4.0/learn/core/schemas/" class="sidebar__sub-link">Schemas</a></li></ul></li><li class="sidebar__item"><a href="/4.0/learn/repositories/" class="sidebar__link">Repositories</a><ul class="sidebar__sub-items"><li class="sidebar__sub-item"><a href="/4.0/learn/repositories/quick-start/" class="sidebar__sub-link">Quick Start</a></li><li class="sidebar__sub-item"><a href="/4.0/learn/repositories/reading-simple-objects/" class="sidebar__sub-link">Reading Simple Objects</a></li><li class="sidebar__sub-item"><a href="/4.0/learn/repositories/reading-aggregates/" class="sidebar__sub-link">Reading Aggregates</a></li><li class="sidebar__sub-item"><a href="/4.0/learn/repositories/changesets/" class="sidebar__sub-link">Changesets</a></li><li class="sidebar__sub-item"><a href="/4.0/learn/repositories/composing-relations/" class="sidebar__sub-link">Composing Relations</a></li><li class="sidebar__sub-item"><a href="/4.0/learn/repositories/custom-changesets/" class="sidebar__sub-link">Custom Changesets</a></li><li class="sidebar__sub-item"><a href="/4.0/learn/repositories/changeset-transactions/" class="sidebar__sub-link">Changeset Transactions & Associations</a></li><li class="sidebar__sub-item"><a href="/4.0/learn/repositories/writing-aggregates/" class="sidebar__sub-link">Writing Aggregates</a></li></ul></li><li class="sidebar__item"><a href="/4.0/learn/sql/" class="sidebar__link--is-active">SQL</a><ul class="sidebar__sub-items"><li class="sidebar__sub-item"><a href="/4.0/learn/sql/relations/" class="sidebar__sub-link">Relations</a></li><li class="sidebar__sub-item"><a href="/4.0/learn/sql/schemas/" class="sidebar__sub-link">Schemas</a></li><li class="sidebar__sub-item"><a href="/4.0/learn/sql/queries/" class="sidebar__sub-link">Queries</a></li><li class="sidebar__sub-item"><a href="/4.0/learn/sql/attributes/" class="sidebar__sub-link">Attributes</a></li><li class="sidebar__sub-item"><a href="/4.0/learn/sql/associations/" class="sidebar__sub-link--is-active">Associations</a></li><li class="sidebar__sub-item"><a href="/4.0/learn/sql/joins/" class="sidebar__sub-link">Joins</a></li><li class="sidebar__sub-item"><a href="/4.0/learn/sql/transactions/" class="sidebar__sub-link">Transactions</a></li><li class="sidebar__sub-item"><a href="/4.0/learn/sql/migrations/" class="sidebar__sub-link">Migrations</a></li><li class="sidebar__sub-item"><a href="/4.0/learn/sql/commands/" class="sidebar__sub-link">Commands</a></li></ul></li><li class="sidebar__item"><a href="/4.0/learn/kafka/" class="sidebar__link">Kafka</a></li><li class="sidebar__item"><a href="/4.0/learn/advanced/" class="sidebar__link">Advanced</a><ul class="sidebar__sub-items"><li class="sidebar__sub-item"><a href="/4.0/learn/advanced/explicit-setup/" class="sidebar__sub-link">Explicit Setup</a></li><li class="sidebar__sub-item"><a href="/4.0/learn/advanced/combine/" class="sidebar__sub-link">Combining Relation Results</a></li><li class="sidebar__sub-item"><a href="/4.0/learn/advanced/commands/" class="sidebar__sub-link">Standalone Commands</a></li><li class="sidebar__sub-item"><a href="/4.0/learn/advanced/custom-commands/" class="sidebar__sub-link">Custom Commands</a></li><li class="sidebar__sub-item"><a href="/4.0/learn/advanced/mappers/" class="sidebar__sub-link">Mappers</a></li><li class="sidebar__sub-item"><a href="/4.0/learn/advanced/how-to-build-an-adapter/" class="sidebar__sub-link">Adapters</a></li></ul></li><li class="sidebar__item"><a href="/4.0/learn/glossary/" class="sidebar__link">Glossary</a></li></ul></div></div><div class="page__content"><div class="content"><h1>SQL &raquo; Associations</h1><p>Relation schemas in SQL land can be used to define canonical associations. These
definitions play important role in automatic mapping of aggregates in repositories.</p>

<h2>belongs_to (many-to-one)</h2>

<p>The <code>belongs_to</code> definition establishes a many-to-one association type.</p>
<pre class="syntax ruby"><code><span class="k">class</span> <span class="nc">Post</span> <span class="o">&lt;</span> <span class="no">ROM</span><span class="o">::</span><span class="no">Relation</span><span class="p">[</span><span class="ss">:sql</span><span class="p">]</span>
  <span class="n">schema</span><span class="p">(</span><span class="ss">infer: </span><span class="kp">true</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">associations</span> <span class="k">do</span>
      <span class="n">belongs_to</span> <span class="ss">:user</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<blockquote>
<h4>Naming convention</h4>

<p>This method is a shortcut for <code>belongs_to :users, as: :user</code></p>
</blockquote>

<h2>has_many (one-to-many)</h2>

<p>The <code>has_many</code> definition establishes a one-to-many association type.</p>
<pre class="syntax ruby"><code><span class="k">class</span> <span class="nc">Users</span> <span class="o">&lt;</span> <span class="no">ROM</span><span class="o">::</span><span class="no">Relation</span><span class="p">[</span><span class="ss">:sql</span><span class="p">]</span>
  <span class="n">schema</span><span class="p">(</span><span class="ss">infer: </span><span class="kp">true</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">associations</span> <span class="k">do</span>
      <span class="n">has_many</span> <span class="ss">:tasks</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<h2>has_many-through (many-to-many)</h2>

<p>The <code>has_many</code> definition supports <code>:through</code> option which establishes a
many-to-many association type.</p>
<pre class="syntax ruby"><code><span class="k">class</span> <span class="nc">Users</span> <span class="o">&lt;</span> <span class="no">ROM</span><span class="o">::</span><span class="no">Relation</span><span class="p">[</span><span class="ss">:sql</span><span class="p">]</span>
  <span class="n">schema</span><span class="p">(</span><span class="ss">infer: </span><span class="kp">true</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">associations</span> <span class="k">do</span>
      <span class="n">has_many</span> <span class="ss">:tasks</span><span class="p">,</span> <span class="ss">through: :users_tasks</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">UsersTasks</span> <span class="o">&lt;</span> <span class="no">ROM</span><span class="o">::</span><span class="no">Relation</span><span class="p">[</span><span class="ss">:sql</span><span class="p">]</span>
  <span class="n">schema</span><span class="p">(</span><span class="ss">infer: </span><span class="kp">true</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">associations</span> <span class="k">do</span>
      <span class="n">belongs_to</span> <span class="ss">:user</span>
      <span class="n">belongs_to</span> <span class="ss">:task</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<h2>has_one (one-to-one)</h2>

<p>The <code>has_one</code> definition establishes a one-to-one association type.</p>
<pre class="syntax ruby"><code><span class="k">class</span> <span class="nc">Users</span> <span class="o">&lt;</span> <span class="no">ROM</span><span class="o">::</span><span class="no">Relation</span><span class="p">[</span><span class="ss">:sql</span><span class="p">]</span>
  <span class="n">schema</span><span class="p">(</span><span class="ss">infer: </span><span class="kp">true</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">associations</span> <span class="k">do</span>
      <span class="n">has_one</span> <span class="ss">:account</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<blockquote>
<h4>Naming convention</h4>

<p>This method is a shortcut for <code>has_one :accounts, as: :account</code></p>
</blockquote>

<h2>has_one-through (one-to-one-through)</h2>

<p>The <code>has_one</code> definition supports <code>:through</code> option which establishes a
one-to-one-through association type.</p>
<pre class="syntax ruby"><code><span class="k">class</span> <span class="nc">Users</span> <span class="o">&lt;</span> <span class="no">ROM</span><span class="o">::</span><span class="no">Relation</span><span class="p">[</span><span class="ss">:sql</span><span class="p">]</span>
  <span class="n">schema</span><span class="p">(</span><span class="ss">infer: </span><span class="kp">true</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">associations</span> <span class="k">do</span>
      <span class="n">has_one</span> <span class="ss">:account</span><span class="p">,</span> <span class="ss">through: :users_accounts</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">UsersAccounts</span> <span class="o">&lt;</span> <span class="no">ROM</span><span class="o">::</span><span class="no">Relation</span><span class="p">[</span><span class="ss">:sql</span><span class="p">]</span>
  <span class="n">schema</span><span class="p">(</span><span class="ss">infer: </span><span class="kp">true</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">associations</span> <span class="k">do</span>
      <span class="n">belongs_to</span> <span class="ss">:account</span>
      <span class="n">belongs_to</span> <span class="ss">:user</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<h2>Aliasing an association</h2>

<p>If you want to use a different name for an association, you can use <code>:as</code> option.
All association types support this feature.</p>

<p>For example, we have <code>:posts</code> belonging to <code>:users</code> but we&#39;d like to call
them <code>:authors</code>:</p>
<pre class="syntax ruby"><code><span class="k">class</span> <span class="nc">Post</span> <span class="o">&lt;</span> <span class="no">ROM</span><span class="o">::</span><span class="no">Relation</span><span class="p">[</span><span class="ss">:sql</span><span class="p">]</span>
  <span class="n">schema</span><span class="p">(</span><span class="ss">infer: </span><span class="kp">true</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">associations</span> <span class="k">do</span>
      <span class="n">belongs_to</span> <span class="ss">:user</span><span class="p">,</span> <span class="ss">as: :author</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<blockquote>
<p>The alias is used by repositories, which means that in our example, if you load
an aggregate with posts and its authors, the attribute name in post structs
will be called <strong>author</strong></p>
</blockquote>

<h2>Extending associations with custom views</h2>

<p>You can use <code>:view</code> option and specify which relation view should be used to extend
default association relation. Let&#39;s say you have users with many accounts through
users_accounts and you want to add attributes from the join relation to accounts:</p>
<pre class="syntax ruby"><code><span class="k">class</span> <span class="nc">Users</span> <span class="o">&lt;</span> <span class="no">ROM</span><span class="o">::</span><span class="no">Relation</span><span class="p">[</span><span class="ss">:sql</span><span class="p">]</span>
  <span class="n">schema</span><span class="p">(</span><span class="ss">infer: </span><span class="kp">true</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">associations</span> <span class="k">do</span>
      <span class="n">has_many</span> <span class="ss">:accounts</span><span class="p">,</span> <span class="ss">through: :users_accounts</span><span class="p">,</span> <span class="ss">view: :ordered</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Accounts</span> <span class="o">&lt;</span> <span class="no">ROM</span><span class="o">::</span><span class="no">Relation</span><span class="p">[</span><span class="ss">:sql</span><span class="p">]</span>
  <span class="n">schema</span><span class="p">(</span><span class="ss">infer: </span><span class="kp">true</span><span class="p">)</span>

  <span class="n">view</span><span class="p">(</span><span class="ss">:ordered</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">schema</span> <span class="k">do</span>
      <span class="n">append</span><span class="p">(</span><span class="n">users_accounts</span><span class="p">[</span><span class="ss">:position</span><span class="p">])</span>
    <span class="k">end</span>

    <span class="n">relation</span> <span class="k">do</span>
      <span class="n">order</span><span class="p">(</span><span class="ss">:position</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<p>This way when you load users with their accounts, they will include <code>:position</code>
attribute from the join table and will be ordered by that attribute.</p>

<h2>Using associations to manually preload relations</h2>

<p>You can reuse queries that associations use in your own methods too via <code>assoc</code>
shortcut method:</p>
<pre class="syntax ruby"><code><span class="k">class</span> <span class="nc">Users</span> <span class="o">&lt;</span> <span class="no">ROM</span><span class="o">::</span><span class="no">Relation</span><span class="p">[</span><span class="ss">:sql</span><span class="p">]</span>
  <span class="n">schema</span><span class="p">(</span><span class="ss">infer: </span><span class="kp">true</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">associations</span> <span class="k">do</span>
      <span class="n">has_many</span> <span class="ss">:tasks</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">admin_tasks</span>
    <span class="n">assoc</span><span class="p">(</span><span class="ss">:tasks</span><span class="p">).</span><span class="nf">where</span><span class="p">(</span><span class="ss">admin: </span><span class="kp">true</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<h2>Setting a custom foreign-key</h2>

<p>By default, foreign keys found in schemas are used, but you can provide custom names too via
<code>:foreign_key</code> option:</p>
<pre class="syntax ruby"><code><span class="k">class</span> <span class="nc">Flights</span> <span class="o">&lt;</span> <span class="no">ROM</span><span class="o">::</span><span class="no">Relation</span><span class="p">[</span><span class="ss">:sql</span><span class="p">]</span>
  <span class="n">schema</span><span class="p">(</span><span class="ss">infer: </span><span class="kp">true</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">associations</span> <span class="k">do</span>
      <span class="n">belongs_to</span> <span class="ss">:destinations</span><span class="p">,</span> <span class="ss">as: :from</span><span class="p">,</span> <span class="ss">foreign_key: :from_id</span>
      <span class="n">belongs_to</span> <span class="ss">:destinations</span><span class="p">,</span> <span class="ss">as: :to</span><span class="p">,</span> <span class="ss">foreign_key: :to_id</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<h2>Using a relation named differently from the table</h2>

<p>It&#39;s a common case for legacy databases to have tables named differently from relations. Your legacy table name must be the first argument and the corresponding relation name must go with <code>:relation</code> option:</p>
<pre class="syntax ruby"><code><span class="k">class</span> <span class="nc">Users</span> <span class="o">&lt;</span> <span class="no">ROM</span><span class="o">::</span><span class="no">Relation</span><span class="p">[</span><span class="ss">:sql</span><span class="p">]</span>
  <span class="n">schema</span><span class="p">(</span><span class="ss">infer: </span><span class="kp">true</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">associations</span> <span class="k">do</span>
      <span class="n">has_many</span> <span class="ss">:todos</span><span class="p">,</span> <span class="ss">as: :tasks</span><span class="p">,</span> <span class="ss">relation: :tasks</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<blockquote>
<p>All association types support this option</p>
</blockquote>

<h2>Learn more</h2>

<p>Check out API documentation:</p>

<ul>
<li><a href="http://www.rubydoc.info/gems/rom-sql/ROM/SQL/Schema/AssociationsDSL">ROM::SQL::Schema::AssociationsDSL</a></li>
<li><a href="http://www.rubydoc.info/gems/rom-sql/ROM/SQL/Association/OneToMany">ROM::SQL::Association::OneToMany</a></li>
<li><a href="http://www.rubydoc.info/gems/rom-sql/ROM/SQL/Association/OneToOne">ROM::SQL::Association::OneToOne</a></li>
<li><a href="http://www.rubydoc.info/gems/rom-sql/ROM/SQL/Association/ManyToOne">ROM::SQL::Association::ManyToOne</a></li>
<li><a href="http://www.rubydoc.info/gems/rom-sql/ROM/SQL/Association/ManyToMany">ROM::SQL::Association::ManyToMany</a></li>
</ul>
</div></div></div></div><div class="footer"><div class="grid"><div class="footer__content"><h3 class="footer__header">Sponsors</h3><p>We are looking for sustainable sponsorship. If your company is relying
on rom-rb or simply want to see rom-rb evolve faster to meet your requirements,
please consider backing the project through <a href="https://opencollective.com/rom">our campaign on
opencollective.com/rom</a>.</p>
</div><div class="footer__fine-print"><div class="footer__fine-print__copyright"><small>&copy; 2014-2017 Ruby Object Mapper. Design by <a href="https://github.com/angeloashmore">@angeloashmore</a>. Logo by <a href="https://github.com/kapowaz">@kapowaz</a>.</small></div><div class="footer__fine-print__social"><a href="https://github.com/rom-rb/rom" class="footer__fine-print__social__icon"><span class="fa fa-github-alt"></span></a><a href="https://twitter.com/rom_rb" class="footer__fine-print__social__icon--last"><span class="fa fa-twitter"></span></a></div></div></div></div></body></html>