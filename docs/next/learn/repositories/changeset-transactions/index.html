<!DOCTYPE html><html><head><meta charset="utf-8" /><meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible" /><meta content="initial-scale=1" name="viewport" /><title>ROM - Changeset Transactions & Associations</title><link href="/assets/stylesheets/all.css" rel="stylesheet" /><script src="/assets/javascripts/all.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-2573270-5', 'auto');
ga('send', 'pageview');</script></head><body class="next next_learn next_learn_repositories next_learn_repositories_changeset-transactions next_learn_repositories_changeset-transactions_index"><div class="page"><div class="grid"><header class="header"><div class="header__logo"><a href="/" class="header__logo__link">Ruby Object Mapper</a></div><div class="header__menu-toggler" id="navigation__toggler"><span class="fa fa-navicon"></span></div><div class="header__menu" id="navigation__items"><nav class="menu"><ul class="menu__items"><li class="menu__item"><a href="/next/learn" class="menu__item__link--is-active">Learn</a></li><li class="menu__item"><a href="/next/guides" class="menu__item__link">Guides</a></li><li class="menu__item"><a href="/api" class="menu__item__link">API</a></li><li class="menu__item"><a href="/blog" class="menu__item__link">Blog</a></li><li class="menu__item"><a href="/contribute" class="menu__item__link">Contribute</a></li><li class="menu__item"><a href="https://discourse.rom-rb.org" class="menu__item__link">Discuss</a></li><li class="menu__item"><a href="/status" class="menu__item__link">Status</a></li><li class="menu__item--last"><a href="https://opencollective.com/rom" class="menu__item__link">Donate</a></li></ul></nav></div></header><div class="page__sidebar"><div class="sidebar"><h3 class="sidebar__version">Version: <select id="sidebar__version-switcher"><option value="/3.0/learn/repositories/changeset-transactions/index.html">3.0</option><option value="/current/learn/repositories/changeset-transactions/index.html">current (3.0)</option><option selected="selected" value="/next/learn/repositories/changeset-transactions/index.html">next (4.0)</option></select></h3><h2 class="sidebar__header--first">Learn</h2><ul class="sidebar__items"><li class="sidebar__item"><a href="/next/learn/introduction/" class="sidebar__link">Introduction</a><ul class="sidebar__sub-items"><li class="sidebar__sub-item"><a href="/next/learn/introduction/philosophy/" class="sidebar__sub-link">Philosophy</a></li><li class="sidebar__sub-item"><a href="/next/learn/introduction/why/" class="sidebar__sub-link">Why ROM?</a></li><li class="sidebar__sub-item"><a href="/next/learn/introduction/overview/" class="sidebar__sub-link">Overview</a></li><li class="sidebar__sub-item"><a href="/next/learn/introduction/active-record/" class="sidebar__sub-link">Active Record and ROM</a></li></ul></li><li class="sidebar__item"><a href="/next/learn/getting-started/" class="sidebar__link">Getting Started</a><ul class="sidebar__sub-items"><li class="sidebar__sub-item"><a href="/next/learn/getting-started/setup-dsl/" class="sidebar__sub-link">Setup DSL</a></li><li class="sidebar__sub-item"><a href="/next/learn/getting-started/rails-setup/" class="sidebar__sub-link">Rails Setup</a></li></ul></li><li class="sidebar__item"><a href="/next/learn/core/" class="sidebar__link">Core</a><ul class="sidebar__sub-items"><li class="sidebar__sub-item"><a href="/next/learn/core/relations/" class="sidebar__sub-link">Relations</a></li><li class="sidebar__sub-item"><a href="/next/learn/core/schemas/" class="sidebar__sub-link">Schemas</a></li></ul></li><li class="sidebar__item"><a href="/next/learn/repositories/" class="sidebar__link--is-active">Repositories</a><ul class="sidebar__sub-items"><li class="sidebar__sub-item"><a href="/next/learn/repositories/quick-start/" class="sidebar__sub-link">Quick Start</a></li><li class="sidebar__sub-item"><a href="/next/learn/repositories/reading-simple-objects/" class="sidebar__sub-link">Reading Simple Objects</a></li><li class="sidebar__sub-item"><a href="/next/learn/repositories/reading-aggregates/" class="sidebar__sub-link">Reading Aggregates</a></li><li class="sidebar__sub-item"><a href="/next/learn/repositories/changesets/" class="sidebar__sub-link">Changesets</a></li><li class="sidebar__sub-item"><a href="/next/learn/repositories/composing-relations/" class="sidebar__sub-link">Composing Relations</a></li><li class="sidebar__sub-item"><a href="/next/learn/repositories/custom-changesets/" class="sidebar__sub-link">Custom Changesets</a></li><li class="sidebar__sub-item"><a href="/next/learn/repositories/changeset-transactions/" class="sidebar__sub-link--is-active">Changeset Transactions & Associations</a></li><li class="sidebar__sub-item"><a href="/next/learn/repositories/writing-aggregates/" class="sidebar__sub-link">Writing Aggregates</a></li></ul></li><li class="sidebar__item"><a href="/next/learn/sql/" class="sidebar__link">SQL</a><ul class="sidebar__sub-items"><li class="sidebar__sub-item"><a href="/next/learn/sql/relations/" class="sidebar__sub-link">Relations</a></li><li class="sidebar__sub-item"><a href="/next/learn/sql/schemas/" class="sidebar__sub-link">Schemas</a></li><li class="sidebar__sub-item"><a href="/next/learn/sql/queries/" class="sidebar__sub-link">Queries</a></li><li class="sidebar__sub-item"><a href="/next/learn/sql/attributes/" class="sidebar__sub-link">Attributes</a></li><li class="sidebar__sub-item"><a href="/next/learn/sql/associations/" class="sidebar__sub-link">Associations</a></li><li class="sidebar__sub-item"><a href="/next/learn/sql/joins/" class="sidebar__sub-link">Joins</a></li><li class="sidebar__sub-item"><a href="/next/learn/sql/transactions/" class="sidebar__sub-link">Transactions</a></li><li class="sidebar__sub-item"><a href="/next/learn/sql/migrations/" class="sidebar__sub-link">Migrations</a></li><li class="sidebar__sub-item"><a href="/next/learn/sql/commands/" class="sidebar__sub-link">Commands</a></li></ul></li><li class="sidebar__item"><a href="/next/learn/kafka/" class="sidebar__link">Kafka</a></li><li class="sidebar__item"><a href="/next/learn/advanced/" class="sidebar__link">Advanced</a><ul class="sidebar__sub-items"><li class="sidebar__sub-item"><a href="/next/learn/advanced/explicit-setup/" class="sidebar__sub-link">Explicit Setup</a></li><li class="sidebar__sub-item"><a href="/next/learn/advanced/combine/" class="sidebar__sub-link">Combining Relation Results</a></li><li class="sidebar__sub-item"><a href="/next/learn/advanced/commands/" class="sidebar__sub-link">Standalone Commands</a></li><li class="sidebar__sub-item"><a href="/next/learn/advanced/custom-commands/" class="sidebar__sub-link">Custom Commands</a></li><li class="sidebar__sub-item"><a href="/next/learn/advanced/mappers/" class="sidebar__sub-link">Mappers</a></li><li class="sidebar__sub-item"><a href="/next/learn/advanced/how-to-build-an-adapter/" class="sidebar__sub-link">Adapters</a></li></ul></li><li class="sidebar__item"><a href="/next/learn/glossary/" class="sidebar__link">Glossary</a></li></ul></div></div><div class="page__content"><div class="content"><h1>Repositories &raquo; Changeset Transactions & Associations</h1><p>If you want to commit multiple changesets, it&#39;s a good idea to wrap that operation in a
repository transaction. Changesets can be associated with each other using <code>Changeset#associate</code>
method, which will automatically set foreign keys for you, based on schema associations.</p>

<p>Let&#39;s define <code>:users</code> relation that has many <code>:tasks</code>:</p>
<pre class="syntax ruby"><code><span class="nb">require</span> <span class="s1">'rom'</span>

<span class="n">rom</span> <span class="o">=</span> <span class="no">ROM</span><span class="p">.</span><span class="nf">container</span><span class="p">(</span><span class="ss">:sql</span><span class="p">,</span> <span class="s1">'sqlite::memory'</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">conf</span><span class="o">|</span>
  <span class="n">conf</span><span class="p">.</span><span class="nf">default</span><span class="p">.</span><span class="nf">create_table</span><span class="p">(</span><span class="ss">:users</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">primary_key</span> <span class="ss">:id</span>
    <span class="n">column</span> <span class="ss">:name</span><span class="p">,</span> <span class="no">String</span><span class="p">,</span> <span class="ss">null: </span><span class="kp">false</span>
  <span class="k">end</span>

  <span class="n">conf</span><span class="p">.</span><span class="nf">default</span><span class="p">.</span><span class="nf">create_table</span><span class="p">(</span><span class="ss">:tasks</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">primary_key</span> <span class="ss">:id</span>
    <span class="n">foreign_key</span> <span class="ss">:user_id</span><span class="p">,</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">null: </span><span class="kp">false</span>
    <span class="n">column</span> <span class="ss">:title</span><span class="p">,</span> <span class="no">String</span><span class="p">,</span> <span class="ss">null: </span><span class="kp">false</span>
  <span class="k">end</span>

  <span class="n">conf</span><span class="p">.</span><span class="nf">relation</span><span class="p">(</span><span class="ss">:users</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">schema</span><span class="p">(</span><span class="ss">infer: </span><span class="kp">true</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">associations</span> <span class="k">do</span>
        <span class="n">has_many</span> <span class="ss">:tasks</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">conf</span><span class="p">.</span><span class="nf">relation</span><span class="p">(</span><span class="ss">:tasks</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">schema</span><span class="p">(</span><span class="ss">infer: </span><span class="kp">true</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">associations</span> <span class="k">do</span>
        <span class="n">belongs_to</span> <span class="ss">:user</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<p>With associations established in the schema, we can easily associate data using changesets and commit
them in a transaction:</p>
<pre class="syntax ruby"><code><span class="k">class</span> <span class="nc">UserRepo</span> <span class="o">&lt;</span> <span class="no">ROM</span><span class="o">::</span><span class="no">Repository</span><span class="p">[</span><span class="ss">:users</span><span class="p">]</span>
  <span class="n">commands</span> <span class="ss">:create</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">TaskRepo</span> <span class="o">&lt;</span> <span class="no">ROM</span><span class="o">::</span><span class="no">Repository</span><span class="p">[</span><span class="ss">:tasks</span><span class="p">]</span>
  <span class="n">commands</span> <span class="ss">:create</span>
<span class="k">end</span>

<span class="n">task_repo</span> <span class="o">=</span> <span class="no">TaskRepo</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">rom</span><span class="p">)</span>
<span class="n">user_repo</span> <span class="o">=</span> <span class="no">UserRepo</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">rom</span><span class="p">)</span>

<span class="n">task</span> <span class="o">=</span> <span class="n">task_repo</span><span class="p">.</span><span class="nf">transaction</span> <span class="k">do</span>
  <span class="n">user</span> <span class="o">=</span> <span class="n">user_repo</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">name: </span><span class="s1">'Jane'</span><span class="p">)</span>

  <span class="n">new_task</span> <span class="o">=</span> <span class="n">task_repo</span><span class="p">.</span><span class="nf">tasks</span><span class="p">.</span><span class="nf">changeset</span><span class="p">(</span><span class="ss">:create</span><span class="p">,</span> <span class="ss">title: </span><span class="s1">'Task One'</span><span class="p">).</span><span class="nf">associate</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>

  <span class="n">task_repo</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">new_task</span><span class="p">)</span>
<span class="k">end</span>

<span class="n">task</span>
<span class="c1"># #&lt;ROM::Struct[Task] id=1 user_id=1 title="Task One"&gt;</span>
</code></pre>
<blockquote>
<h3>Association name</h3>

<p>Notice that <code>associate</code> method can accept a rom struct and it will try to infer
association name from it. If this fails because you have an aliased association
then pass association name explicitly as the second argument, ie: <code>associate(user, :author)</code></p>
</blockquote>

<h2>Learn more</h2>

<ul>
<li><a href="http://www.rubydoc.info/gems/rom-repository/ROM/Changeset/Stateful#associate-instance_method">Changeset::Stateful#associate</a></li>
<li><a href="http://www.rubydoc.info/gems/rom-repository/ROM/Repository#transaction-instance_method">Repository#transaction</a></li>
</ul>
</div></div></div></div><div class="footer"><div class="grid"><div class="footer__content"><h3 class="footer__header">Sponsors</h3><p>We are looking for sustainable sponsorship. If your company is relying
on rom-rb or simply want to see rom-rb evolve faster to meet your requirements,
please consider backing the project through <a href="https://opencollective.com/rom">our campaign on
opencollective.com/rom</a>.</p>
</div><div class="footer__fine-print"><div class="footer__fine-print__copyright"><small>&copy; 2014-2017 Ruby Object Mapper. Design by <a href="https://github.com/angeloashmore">@angeloashmore</a>. Logo by <a href="https://github.com/kapowaz">@kapowaz</a>.</small></div><div class="footer__fine-print__social"><a href="https://github.com/rom-rb/rom" class="footer__fine-print__social__icon"><span class="fa fa-github-alt"></span></a><a href="https://twitter.com/rom_rb" class="footer__fine-print__social__icon--last"><span class="fa fa-twitter"></span></a></div></div></div></div></body></html>